<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <h1>Your Cart</h1>
    <div id="cart-list"></div>
    <p id="total-amount"></p>
    <button onclick="goToShop()">Continue Shopping</button>
    <button id="checkout-button" onclick="checkout()">Checkout</button>

    <script>
        let totalAmount = 0;  // To store the total amount of the cart

        async function fetchCartItems() {
            const user_id = localStorage.getItem('user_id');
            if (!user_id) {
                alert("You must be logged in to view the cart.");
                return;
            }

            const response = await fetch(`https://labour-hester-hemang-841401d3.koyeb.app/cart/${user_id}`);
            const result = await response.json();

            const cartList = document.getElementById('cart-list');
            cartList.innerHTML = '';

            // Log the result to check the data format
            console.log(result);

            // Check if result contains the cart items
            if (result ) {
                result.forEach(item => {
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.classList.add('cart-item');
                    cartItemDiv.innerHTML = `
                        <h2>${item.product_id.name}</h2>
                        <p>Price: $${item.product_id.price}</p>
                        <p>Quantity: ${item.quantity}</p>
                        <button onclick="removeFromCart('${item.product_id}')">Remove from Cart</button>
                    `;
                    cartList.appendChild(cartItemDiv);
                    totalAmount = totalAmount + (item.product_id.price*item.quantity)
                });
            } else {
                cartList.innerHTML = '<p>Your cart is empty.</p>';
            }
        }


        async function removeFromCart(productId) {
            const user_id = localStorage.getItem('user_id');
            if (!user_id) {
                alert("You must be logged in to remove items from the cart.");
                return;
            }

            const response = await fetch('https://labour-hester-hemang-841401d3.koyeb.app/cart', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id, id: productId })
            });

            const result = await response.json();
            alert(result.message);
            fetchCartItems();  // Refresh the cart after deletion
        }

        async function checkout(total_amount, product_id) {
            const user_id = localStorage.getItem('user_id');
            if (!user_id) {
                alert("You must be logged in to checkout.");
                return;
            }
            const cartResponse = await fetch('https://labour-hester-hemang-841401d3.koyeb.app/cart/${user_id}')
            // Create an order
            const orderResponse = await fetch('https://labour-hester-hemang-841401d3.koyeb.app/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id, total_amount: totalAmount, product_id: product_id })
            });

            const orderResult = await orderResponse.json();
            const order_id = orderResult.id;

            // Create an invoice for the order
            const invoiceResponse = await fetch('https://labour-hester-hemang-841401d3.koyeb.app/invoice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id, total_amount: totalAmount })
            });

            const invoiceResult = await invoiceResponse.json();
            alert(`Checkout successful! Your invoice number is ${invoiceResult.invoice_number}`);
            
            // Optionally, redirect to another page
            window.location.href = 'shop.html';  // Redirect to orders or confirmation page
        }

        function goToShop() {
            window.location.href = 'shop.html';
        }

        // Call fetchCartItems to load cart items when the page loads
        fetchCartItems();
    </script>
</body>
</html>
